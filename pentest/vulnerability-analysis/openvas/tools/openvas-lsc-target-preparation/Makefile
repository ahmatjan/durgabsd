VERSION=$(shell cat VERSION)
NAME=$(shell cat NAME)
RPMBASENAME=$(shell cat RPMBASENAME)
PUBKEYNAME=$(shell cat PUBKEYNAME)
RPMNAME=$(RPMBASENAME)-$(PUBKEYNAME)
FILES=$(shell xargs < MANIFEST)
#PACKDIR=$(shell mktemp -d /tmp/thisgoesawayXXXXX )
PACKDIR=/tmp/blubber
EXECUTE_DIR=$(shell basename $(PACKDIR))

default:
	# NOP, no operation

# Creating the fundamental directories and contents for the RPM
# building, not using the system defaults
configure: rpmdist
	mkdir SOURCES
	mkdir RPMS
	mkdir BUILD
	mv $(RPMNAME)-$(VERSION).tar.gz SOURCES/

install:
	cp lsc-pubkey.pub $(RPM_BUILD_ROOT)/home/$(PUBKEYNAME)/.ssh/authorized_keys

clean:
	LC_ALL=C ls | egrep -v "\.spec" | diff  MANIFEST - | grep "^>" | sed 's/^..//' | xargs rm -rf

# The default pubkey is used as an example, to test the building
# system locally. An RPM should be generated.
test:
	cp ~/.ssh/id_rsa.pub id_rsa_sshovas.pub
	sh create-rpm.sh id_rsa_sshovas.pub

# "make rpmdist" Packing this same system with the changed name into RPM SOURCES
# directory
rpmdist: clean
	echo $(FILES)
	mkdir $(RPMNAME)-$(VERSION)
	cp -ar $(FILES) $(RPMNAME)-$(VERSION)/
	tar cfzv $(RPMNAME)-$(VERSION).tar.gz $(RPMNAME)-$(VERSION)
	rm -rf $(RPMNAME)-$(VERSION)

# "make dist": Everything, even the *.spec file is cleaned up
dist: distclean
	echo $(FILES)
	mkdir $(NAME)-$(VERSION)
	cp -ar $(FILES) $(NAME)-$(VERSION)/
	tar cfzv $(NAME)-$(VERSION).tar.gz $(NAME)-$(VERSION)
	rm -rf $(NAME)-$(VERSION)

# "make self" generates the all-containing shellscript.
# This is the script to be used on the RPM building machines:
# <shellscript.sh> </absolute/path/to/pubkey.pub>
self: distclean
	rm -rf $(PACKDIR)
	mkdir $(PACKDIR)
	cp -ar $(FILES) $(PACKDIR)/
	./makeself-2.1.5/makeself.sh --nox11 --notemp --nocomp $(PACKDIR) openvas-lsc-rpm-creator.sh "OpenVAS LSC RPM creator" ./create-rpm.sh
	rm -rf $(PACKDIR)

# If you plan to add files or directories to this system, please do
# "make distclean", add the files and then
# "make manifest". So everything should go straight.
manifest:
	ls > MANIFEST

#
distclean: clean
	rm -f PUBKEYNAME *.spec lsc-pubkey.pub
	touch PUBKEYNAME lsc-pubkey.pub

.PHONY: clean default install test distclean manifest
