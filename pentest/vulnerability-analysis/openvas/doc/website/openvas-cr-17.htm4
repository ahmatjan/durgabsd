m4_dnl -*-html-*-
m4_include(`template.m4')

m4_dnl OpenVAS
m4_dnl $Id$
m4_dnl Description: OpenVAS Change Request #17
m4_dnl
m4_dnl Authors:
m4_dnl Michael Wiegand <michael.wiegand@intevation.de>
m4_dnl
m4_dnl Copyright:
m4_dnl Copyright (C) 2008 Intevation GmbH
m4_dnl
m4_dnl This program is free software; you can redistribute it and/or
m4_dnl modify it under the terms of the GNU General Public License
m4_dnl as published by the Free Software Foundation; either version 2
m4_dnl of the License, or (at your option) any later version.
m4_dnl
m4_dnl This program is distributed in the hope that it will be useful,
m4_dnl but WITHOUT ANY WARRANTY; without even the implied warranty of
m4_dnl MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
m4_dnl GNU General Public License for more details.
m4_dnl
m4_dnl You should have received a copy of the GNU General Public License
m4_dnl along with this program; if not, write to the Free Software
m4_dnl Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.

m4_define(`EN')
m4_define(`TITLE', `OpenVAS')
m4_define(`MAIN', `misc')



PAGE_START
<h2>OpenVAS Change Request #17: OTP: Make NVT signatures available to OpenVAS-Client</h2>

Status: Voted +1. Done. Implemented with SVN 1742.

<h3>Purpose</h3>

<p>
  To make NVT signatures more transparent to the user and ultimately enable the
  user to verify the trust set in the NVTs.
</p>

<h3>References</h3>

<p>
  <a href="http://lists.wald.intevation.org/pipermail/openvas-devel/2008-October/000972.html">
  Discussion on mailing list. </a>
</p>

<h3>Rationale</h3>

<p>
  In the current implementation, NVT signatures are verified by OpenVAS-Server.
  The server can be configured to enable only signed and trusted NVTs and will
  in that case only transmit those NVTs to the client which are signed with a
  trustworthy signature.
</p>

<p>
  This behavior leaves no way for the user to verify who signed which NVT and
  prevents him from making up his own mind regarding the trustworthiness of the
  NVTs he is about to execute since the signature information is not transmitted
  to the client.
</p>

<p>
  A better option would be to provide the OpenVAS client (and therefore the user)
  with more information regarding plugin signatures.
</p>

<h3>Effects</h3>

<p>
  This change would add protocol elements to OTP 1.0 which enable the server
  to transmit signature and trust data to the client and would introduce handling
  for this new element in the appropriate places. It would also extend the client
  GUI to display the information received from the server to the user.
</p>


<h3>Design and Implementation</h3>

<p>
  The signature information will be included in the PLUGIN_INFO and PLUGIN_LIST
  message types as a last element; this is the easiest solution.
  The current per-NVT response is:<br>
  <pre>oid &lt;|&gt; name &lt;|&gt; category &lt;|&gt; copyright &lt;|&gt; description &lt;|&gt; summary &lt;|&gt; family &lt;|&gt; plugin_version &lt;|&gt; cve_id &lt;|&gt; bugtraq_id &lt;|&gt; xrefs</pre><br>
  After the change it would become:<pre>oid &lt;|&gt; name &lt;|&gt; category &lt;|&gt; copyright &lt;|&gt; description &lt;|&gt; summary &lt;|&gt; family &lt;|&gt; plugin_version &lt;|&gt; cve_id &lt;|&gt; bugtraq_id &lt;|&gt; xrefs &lt;|&gt; nvt_fprs</pre><br>
  "nvt_fprs" is a list of the fingerprints of the keys used to sign this NVTs
  separated by commas. The size of the new field is restricted to 48*3+2 
  characters, which allows 3 fingerprints to be commited.
</p>

<p>
  The server implements a command that allows the client to retrieve all
  the certificates (public keys) that are known to the server with a value
  indicating whether the server trusts this certificated or not. This could
  happen in the following way:<br>
  Client:<br>
  <pre>CLIENT &lt;|&gt; CERTIFICATES &lt;|&gt; CLIENT</pre><br>
  Server:<br>
  <pre>SERVER &lt;|&gt; CERTIFICATES<br>
[certificate_fpr] &lt;|&gt; [owner_name] &lt;|&gt; [trusted/untrusted] &lt;|&gt; pubkey_nr_bytes &lt;|&gt; pubkey_ascii<br>
[certificate_fpr] &lt;|&gt; [owner_name] &lt;|&gt; [trusted/untrusted] &lt;|&gt; pubkey_nr_bytes &lt;|&gt; pubkey_ascii<br>
[certificate_fpr] &lt;|&gt; [owner_name] &lt;|&gt; [trusted/untrusted] &lt;|&gt; pubkey_nr_bytes &lt;|&gt; pubkey_ascii<br>
&lt;|&gt; SERVER</pre><br>
  where pubkey_ascii is the full public key, ascii-armored and with newlines 
  being replaced by semicolons (to keep a consistent mechanism with other otp
  commands that might send newlines).
</p>

<p>
  Following changes have been done:
</p>

<h4> Changes in openvas-client </h4>

<ul>
<li> A new field (simple string as transmitted - see above) in the plugin struct
  and access methods for it were  added in nessus/plugin.c.
<li> General protocol changes are reflected in the clients "Communication 
  Manager" nessus/comm.c </li>
<li> Fingerprints are included in the client-side cache (nessus/plugin_cache.c).
  </li>
<li> A copy of the openvas_certificate struct and functions (see below) is included
  in the client. The duplicate issue will be resolved in future versions.
  </li>
<li> Certificate data is held per scope in the context in a GHashTable, where
  fingerprints are keys and pointers to the certificate structs are values.
  </li>
<li> Signatures and the servers trust in that key are shown in the plugin info
  dialog. A button allows to open a window with a text view of the public key.
</li>
</ul>



<h4> Changes in openvas-libraries / openvas-libnasl </h4>

<ul>
<li> Unfortunately, duplicates of changes made to the plugin and openvas_certificate
  struct in the client. Duplicate will be resolved through merge and dependency 
  openvas-client -> openvas-libraries. Changes in openvas-libnasl should be moved 
  to openvas-libraries, as there is no nasl specificity anymore (e.g. signed 
  OVAL plugins).
</li>
<li> Extraction of key-ids using gpgme. </li>
<li> Extraction of certificate information using gpgme. </li>
</ul>


<h4> Changes in openvas-server </h4>
<ul>
<li> General protocol changes are reflected in the servers "Communication 
  Manager" openvasd/comm.c and handling the elements in /openvasd/otp_1_0.h/c.
  </li>
<li> The cache uses the new field (in nessus/pluginload.c).
  </li>
<li> Sends list of certificates. </li>
</ul>

<h3>History</h3>

<ul>

<li> 2008-11-14 Felix Wolfsteller &lt;felix.wolfsteller@intevation.de&gt;:<br>
     Updated to fit actual implementation, marked done.
<li> 2008-10-22 Felix Wolfsteller &lt;felix.wolfsteller@intevation.de&gt;:<br>
     Updated design and implementation part</li>
<li> 2008-10-16 Michael Wiegand &lt;michael.wiegand@intevation.de&gt;:<br>
     Updated protocol specification.</li>
<li> 2008-10-13 Michael Wiegand &lt;michael.wiegand@intevation.de&gt;:<br>
     Initial text.</li>
</ul>
