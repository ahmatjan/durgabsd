# OpenVAS
# $Id$
# Description: Build html from m4 macrofilesfor OpenVAS Web-Site.
#
# Authors:
# Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>
#
# Copyright:
# Copyright (C) 2007 Software in the Public Interest, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2,
# as published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.

# Preprocessor configuration
PP = m4
PPFLAGS = --prefix-builtins

# Build configuration
TARGETS = $(patsubst %.htm4,%.html,$(wildcard *.htm4))
SUBDIRS = 

# Installation configuration
INSTALL_DIR = /tmp/openvas-www
ADD_INST_TYPES = *.css *.asc *.psp .htaccess *.patch *.pdf *.ico
ADD_INST_DIRS = pix img screenshots

USER=$(shell svn info | grep "svn+ssh://" | sed -e "s/.*svn+ssh:\/\///g" | sed -e "s/@.*//g" | head -1)

CURDIR=$(shell pwd)

.SUFFIXES: .html .htm4

.htm4.html:
	$(PP) $(PPFLAGS) $< > $@

all: $(TARGETS) subdirs

$(TARGETS): template.m4 template_header.m4 header.m4

subdirs: $(SUBDIRS)
	@for dir in $^ ; do \
	  $(MAKE) -C $$dir SUBDIRS="" ; \
	done

online: all
	echo "Going to put current contents online for openvas.wald.intevation.org ..."
	rsync --protocol=29 -urvPC --exclude='.svn' --perms --chmod=ug+rw,o+r,Dg+s,Da+x,u-s,Fg-s,o-wt \
	$(ADD_INST_TYPES) $(TARGETS) $(ADD_INST_DIRS) $(USER)@wald.intevation.org:/openvas/htdocs/

install: all
	mkdir -p $(INSTALL_DIR) ;\
	cp -uf $(TARGETS) $(INSTALL_DIR) ;\
	cp -uf $(ADD_INST_TYPES) $(INSTALL_DIR)
	cp -urf *$(ADD_INST_DIRS) $(INSTALL_DIR)
	find $(INSTALL_DIR) -name ".svn" | xargs rm -rf

tar: install
	echo $(CURDIR)
	( cd $(INSTALL_DIR) ; tar -czv -f $(CURDIR)/openvas.wald.org.tar.gz . )

clean: 
	rm -f *.html
